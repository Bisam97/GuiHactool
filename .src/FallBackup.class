' Gambas class file

Private $Pathlist As String[]
Private $onCopy As Boolean
Private $onDecrypt As Boolean
Private $isNext As Boolean
Private $isFinishCopy As Boolean
Private $isFinishDecrypt As Boolean
Private $i As Integer
Private $watch As Watch
Private $currendsize As Long
Private $Ramdiskuse As Boolean
Private $sduse As Boolean



Public Sub Button1_Click()

  Dim s As String
  Dim sa As String[]
  Dim size As CSize
  Dim c As Collection
  Dim i As Integer
  Dim checkS As Long
  Dim dirf As String
  Dim toBig As Collection

  Button1.Enabled = False
  ButtonBox1.Enabled = False
  ButtonBox2.Enabled = False


  If User.Name = "root" Then

    Select Message.Question("You run the Programm as root.\nIs it ok to use 80% of your RAM for a fast Dump and Decryption?", "yes", "no", "?")
      Case 1
        Try Mkdir "/tmp/hactoolgui"
        $Ramdiskuse = True
        Shell "mount -t tmpfs -o size=80% hactool /tmp/hactoolgui"
        Shell "df -BKB > /tmp/out.txt" Wait
        s = File.Load("/tmp/out.txt")
        sa = Split(s, " " & gb.NewLine, Null, True)
        size = New CSize(CLong(String.Left$(sa[1 + sa.Find("hactool")], -2) * 1000))


        Message.Info("Ramdisk created in '/tmp/hactoolgui' with the size '" & size.GigaByte & "GB'")

    End Select
  Endif



  MlookAtgames.setdir(ButtonBox1.Text)
  $Pathlist = MlookAtgames.look()["Path"]

  If $Ramdiskuse Then

    c = New Collection
    toBig = New Collection
    i = 1
    $sduse = Stat($Pathlist[0]).Type = gb.Directory

    For Each s In $Pathlist
      '' With RAM Disk Use Code (parallel mode faster)

      Try Mkdir "/tmp/hactoolgui" &/ i
      If Error.Code = 38 Then Error.Clear
      If Error Then Message.Error(Error.Text & "\n" & Error.Where, "ok")
      checkS = 0
      If $sduse Then
        For Each dirf In Dir(s)

          checkS += Stat(s &/ dirf).Size

        Next

      Else
        checkS = Stat(s).Size
      Endif
      If Stat(s).Size < size.Byte Then
        c.Add(i, s)
        i += 1
        Print "Erfolgreich hinzugefügt mit der größe " & checkS
      Else
        toBig.Add(i & "to big", s)
        Print "File " & s & " to big with " & checkS
      Endif
    Next



  Else
    '' Without RAM Disk Use Code (serial mode slower)
    $isNext = True
    ' OLD CODE
    Try Mkdir ButtonBox2.Text &/ ".work"
    Try Kill ButtonBox2.Text &/ ".work" &/ "game.bin"

    $watch = New Watch(ButtonBox2.Text &/ ".work") As "Watch"
    MlookAtgames.setdir(ButtonBox1.Text)
    $Pathlist = MlookAtgames.look()["Path"]
    $isNext = True
    Me.Copy_old()
    Timer1.Start


  Endif




End

Public Sub Watch_Close()

  Print Watch.Name
  Select Watch.Name
    Case "game.bin"

    Case "game.nca"
      If $onDecrypt Then
        $onDecrypt = False
        $isFinishDecrypt = True
        Me.Decryptfin()
      Endif
  End Select

End

Public Sub Copy()



End

Public Sub Copy_old() ''OLD CODE

  Dim a As String[]
  Dim d As String

  If $i = $Pathlist.Length Then

    FTitleName.ButtonBox1.Text = ButtonBox2.Text
    FTitleName.Button1_Click()

  Else
    If $isNext Then
      $watch.Pause()
      $isNext = False
      ProgressBar1.Value = 0
      ProgressBar2.Value = 0
      ProgressBar3.Value = $i / $Pathlist.Length
      Try Kill ButtonBox2.Text &/ ".work/game.bin"
      Wait 3
      $onCopy = True
      a = Split($Pathlist[$i], "/")
      File.Save(ButtonBox2.Text &/ ".work/game.bin.path", "/" & a[a.Find("registered")] &/ a[a.Find("registered") + 1] &/ a[a.Find("registered") + 2])
      $currendsize = Stat($Pathlist[$i]).Size
      $watch.Resume

      If Stat($Pathlist[$i]).Type = gb.Directory Then

        $currendsize = 0
        For Each d In Dir($Pathlist[$i])

          $currendsize += Stat($Pathlist[$i] &/ d).Size



        Next
        Shell "cat " & $Pathlist[$i] &/ "* > " & ButtonBox2.Text &/ ".work/game.bin"






      Else
        Shell "cat " & $Pathlist[$i] & " > " & ButtonBox2.Text &/ ".work/game.bin"
      Endif




      Print "Copy now.... " & $Pathlist[$i]
      $i += 1




    Endif
  Endif

End

Public Sub Decrypt()

  If $isFinishCopy Then

    $isFinishCopy = False
    Shell "hactool -tnax0 --plaintext=" & ButtonBox2.Text &/ ".work/game.nca" & " --sdseed=" & FMain.$ProdKeylist["sd_seed"] & " --sdpath=" & File.Load(ButtonBox2.Text &/ ".work/game.bin.path") & " " & ButtonBox2.Text &/ ".work/game.bin"
    $onDecrypt = True
  Endif

End

Public Sub Decryptfin()

  Dim a As String[]
  Dim titleID As String
  Dim type As String
  Dim i As Integer

  If $isFinishDecrypt Then
    $isFinishDecrypt = False
    Shell "hactool " & ButtonBox2.Text &/ ".work/game.nca >/tmp/hactool.txt" Wait

    a = Split(File.Load("/tmp/hactool.txt"), ": " & gb.NewLine, "", True)

    Try titleID = a[a.Find("Title") + 2]
    Try type = a[a.Find("Type") + 1]
    If Error Then
    Else
      Try Mkdir ButtonBox2.Text &/ titleID
      $currendsize = Stat(ButtonBox2.Text &/ ".work/game.nca").Size
      Wait 0.3
      If Exist(ButtonBox2.Text &/ titleID &/ type & ".nca") Then

        i = 1
        While Exist(ButtonBox2.Text &/ titleID &/ type & i & ".nca")
          i += 1

        Wend

        Move ButtonBox2.Text &/ ".work/game.nca" Kill ButtonBox2.Text &/ titleID &/ type & i & ".nca"
        Move ButtonBox2.Text &/ ".work/game.bin.path" Kill ButtonBox2.Text &/ titleID &/ type & i & ".nca.path"


      Else
        Move ButtonBox2.Text &/ ".work/game.nca" Kill ButtonBox2.Text &/ titleID &/ type & ".nca"
        Move ButtonBox2.Text &/ ".work/game.bin.path" Kill ButtonBox2.Text &/ titleID &/ type & ".nca.path"
      Endif
      While Not Stat(ButtonBox2.Text &/ titleID &/ type & ".nca").Size = $currendsize
        Print "wait hold on"
      Wend
    Endif
    $isNext = True
    Me.Copy_old()
    ProgressBar3.Value = $i / $Pathlist.Length
  Endif

End

Public Sub Timer1_Timer()





  If $onCopy Then

    Try ProgressBar1.Value = Stat(ButtonBox2.Text &/ ".work/game.bin").Size / $currendsize
    If Exist(ButtonBox2.Text &/ ".work/game.bin") Then
      If Stat(ButtonBox2.Text &/ ".work/game.bin").Size = $currendsize Then
        If $onCopy Then
          $onCopy = False
          $isFinishCopy = True
          Me.Decrypt()
        Endif
      Endif
    Endif

  Else If $onDecrypt Then

    Try ProgressBar2.Value = Stat(ButtonBox2.Text &/ ".work/game.nca").Size / $currendsize



  Endif



End

Public Sub ButtonBox1_Click()

  If Not Dialog.SelectDirectory() Then
    ButtonBox1.Text = Dialog.path
  Endif

End

Public Sub ButtonBox2_Click()

  If Not Dialog.SelectDirectory() Then
    ButtonBox2.Text = Dialog.path
  Endif

End

Public Sub Form_Close()

  If $Ramdiskuse Then

    Shell "umount /tmp/hactoolgui" Wait
    Shell "rm -r /tmp/hactoolgui" Wait
  Endif

End

